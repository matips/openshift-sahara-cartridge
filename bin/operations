#!/bin/sh
source ../cluster/config.properties
JQ="${OPENSHIFT_SP_DIR}/bin/jq"
function authenticate(){
    curl -s -X POST "$OPENSTACK_AUTH_URL"/tokens \
                    -H "Content-Type: application/json" \
                    -d @"${OPENSHIFT_SP_DIR}"cluster/json/authenticate.json \
                    > "${OPENSHIFT_SP_DIR}"tmp/response_authenticate.json

    # parse response and save token to appropriate variable
    TOKEN=`cat ${OPENSHIFT_SP_DIR}tmp/response_authenticate.json | ${JQ} -r '.access.token.id'`
    client_message "Your token is: $TOKEN"
    OPENSTACK_TOKEN=${TOKEN}
    echo "Token is saved in OPENSTACK_TOKEN env variable: $OPENSTACK_TOKEN" >> ${OPENSHIFT_SP_LOG}
}

function createClusterTemplate(){
    authenticate

    cat  "${OPENSHIFT_SP_DIR}"/cluster/json/cluster_basic.json | \
               ${JQ} ".node_groups[0].node_group_template_id = \"${SPARK_TEMPLATE_MASTER_ID}\"" | \
               ${JQ} ".node_groups[1].node_group_template_id = \"${SPARK_TEMPLATE_SLAVE_ID}\"" | \
               ${JQ} ".node_groups[1].count = \"${WORKERS_COUNT}\"" \
               > ${OPENSHIFT_SP_DIR}/tmp/cluster_basic_resolved.json

    curl -s -X POST "$SAHARA_URL/cluster-templates" \
                    -H "Content-Type: application/json" \
                    -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                    -d @"${OPENSHIFT_SP_DIR}"/tmp/cluster_basic_resolved.json \
                    > "${OPENSHIFT_SP_DIR}"/tmp/response_cluster_basic.json

    SPARK_CLUSTER_TEMPLATE_ID=`cat ${OPENSHIFT_SP_DIR}tmp/response_cluster_basic.json | ${JQ} -r '.cluster_template.id'`

    echo "Cluster template id: $SPARK_CLUSTER_TEMPLATE_ID" >> ${OPENSHIFT_SP_LOG}
}
function deleteCluster(){
    if [ ! -z "$1"  -a -f "$1" ]
    then
        source $1
    fi

    authenticate

    getClusterIdByName

    client_message "Deleting cluster with id: $SPARK_CLUSTER_ID"

    curl -s -X DELETE "$SAHARA_URL/clusters/$SPARK_CLUSTER_ID"  \
                    -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                    -w "%{http_code}" \
                    > "${OPENSHIFT_SP_DIR}"/tmp/response_delete_cluster.code

    DELETE_RESPONSE_CODE=`cat "${OPENSHIFT_SP_DIR}"/tmp/response_delete_cluster.code`
    client_message "Cluster with id: $SPARK_CLUSTER_ID removed with code $DELETE_RESPONSE_CODE"
    echo "Cluster with id: $SPARK_CLUSTER_ID removed with code $DELETE_RESPONSE_CODE"  >> ${OPENSHIFT_SP_LOG}
}

function createCluster(){
    if [ ! -z "$1"  -a -f "$1" ]
    then
        source $1
    fi

    authenticate

    cat ${OPENSHIFT_SP_DIR}cluster/json/launch_cluster.json | \
                ${JQ} ".cluster_template_id = \"${SPARK_CLUSTER_TEMPLATE_ID}\"" | \
                ${JQ} ".user_keypair_id = \"${SPARK_USER_KEY_PAIR}\"" | \
                ${JQ} ".name = \"${SPARK_CLUSTER_NAME}\"" \
                > "${OPENSHIFT_SP_DIR}"/tmp/launch_cluster_resolved.json

    echo `cat "${OPENSHIFT_SP_DIR}"/tmp/launch_cluster_resolved.json`  >> ${OPENSHIFT_SP_LOG}

    client_message "Creating cluster from template: ${SPARK_CLUSTER_TEMPLATE_ID}"
    client_message "Cluster name: ${SPARK_CLUSTER_NAME}"

    curl -s -X POST "$SAHARA_URL/clusters" \
                    -H "Content-Type: application/json" \
                    -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                    -d @"${OPENSHIFT_SP_DIR}"/tmp/launch_cluster_resolved.json \
                    > "${OPENSHIFT_SP_DIR}"/tmp/response_launch_cluster.json

    echo `cat "${OPENSHIFT_SP_DIR}"/tmp/response_launch_cluster.json`  >> ${OPENSHIFT_SP_LOG}

    check_json_errors response_launch_cluster "creating cluster"

    if [ ${ERROR} == 'NAME_ALREADY_EXISTS' ]
    then
        echo "Cluster already exists" >> ${OPENSHIFT_SP_LOG}
        client_message "Cluster already exists"

        getClusterIdByName

        client_message "Existing cluster ID: ${SPARK_CLUSTER_ID}"

    else
        SPARK_CLUSTER_ID=`cat ${OPENSHIFT_SP_DIR}tmp/response_launch_cluster.json | ${JQ} -r '.cluster.id'`
        client_message "Created cluster ID: ${SPARK_CLUSTER_ID}"
    fi

    echo $SPARK_MANAGEMENT_KEY > ${OPENSHIFT_SP_DIR}tmp/SPARK_MANAGEMENT_KEY

    echo "Cluster id: $SPARK_CLUSTER_ID" >> ${OPENSHIFT_SP_LOG}
}

function getClusterIdByName(){

        curl -s -X GET "$SAHARA_URL/clusters" \
                        -H "Content-Type: application/json" \
                        -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                        > "${OPENSHIFT_SP_DIR}"/tmp/response_list_clusters.json

        SPARK_CLUSTER_ID=`cat ${OPENSHIFT_SP_DIR}tmp/response_list_clusters.json |
                ${OPENSHIFT_SP_DIR}/bin/jq '.clusters' |
                ${OPENSHIFT_SP_DIR}/bin/jq "map(select(.name==\"${SPARK_CLUSTER_NAME}\"))[0].id" |
                cut -d "\"" -f2`

}

function deployJob(){
        if [ ! -z "$1"  -a -f "$1" ]
        then
            source $1
        fi

        authenticate


        if [ -f $JOB_BINARY ];
        then
            createJobInternal


            createJobBinary


            if [ ${ERROR} == 'DB_DUPLICATE_ENTRY' ]
            then
                curl -s -X GET "$SAHARA_URL/job-binaries" \
                            -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                            > "${OPENSHIFT_SP_DIR}"/tmp/job-binaries_list.json


                JOB_BINARY_ID=`cat ${OPENSHIFT_SP_DIR}tmp/job-binaries_list.json |
                        ${OPENSHIFT_SP_DIR}/bin/jq '.binaries' |
                        ${OPENSHIFT_SP_DIR}/bin/jq "map(select(.name==\"$(basename $JOB_BINARY)\"))[0].id" |
                        cut -d "\"" -f2`

                client_message "Searched JOB_BINARY_ID=${JOB_BINARY_ID}"


                curl -s -X DELETE  "${SAHARA_URL}/job-binaries/${JOB_BINARY_ID}" \
                            -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                            -w "%{http_code}" \
                            > "${OPENSHIFT_SP_DIR}"/tmp/job_binary_internals_delete_result.txt

                client_message "Deleting job binary status code: $(cat "${OPENSHIFT_SP_DIR}"/tmp/job_binary_internals_delete_result.txt)"
                client_message "Creating job binary again..."
                createJobBinary
            fi

            createJob
            runJob

        else
           client_message "File $JOB_BINARY does not exist."
        fi
}

rawurlencode() {
  local string="${1}"
  local strlen=${#string}
  local encoded=""

  for (( pos=0 ; pos<strlen ; pos++ )); do
     c=${string:$pos:1}
     case "$c" in
        [-_.~a-zA-Z0-9] ) o="${c}" ;;
        * )               printf -v o '%%%02x' "'$c"
     esac
     encoded+="${o}"
  done
  #echo "${encoded}"    # You can either set a return variable (FASTER)
  REPLY="${encoded}"   #+or echo the result (EASIER)... or both... :p
}

function check_json_errors() {

    ERROR=`cat ${OPENSHIFT_SP_DIR}tmp/${1}.json | ${JQ} -r '.error_name?'`
    ERROR_MESSAGE=`cat ${OPENSHIFT_SP_DIR}tmp/${1}.json | ${JQ} -r '.error_message?'`

    if [ ${ERROR} != 'null' ]
    then
        client_message "Error [${ERROR}] when ${2}: ${ERROR_MESSAGE}"
    fi
}
function createJobBinary() {

            client_message "Creating job binary..."
            cat ${OPENSHIFT_SP_DIR}cluster/json/job_binary.json | \
                ${JQ} ".url = \"internal-db://${JOB_INTERNAL_ID}\"" | \
                ${JQ} ".name = \"$(basename $JOB_BINARY)\"" \
                > "${OPENSHIFT_SP_DIR}"/tmp/job_binary_resolved.json

            curl -s -X POST "$SAHARA_URL/job-binaries" \
                         -H "Content-Type: application/json" \
                         -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                         -d @"${OPENSHIFT_SP_DIR}"/tmp/job_binary_resolved.json \
                         > "${OPENSHIFT_SP_DIR}"/tmp/job_binary_response.json

           check_json_errors job_binary_response "creating job-binary"

           JOB_BINARY_ID=`cat "${OPENSHIFT_SP_DIR}"/tmp/job_binary_response.json | ${JQ} -r '.job_binary.id'`

           client_message "Created job binary id: ${JOB_BINARY_ID}"
}
function createJob() {

            client_message "Creating job..."
            cat ${OPENSHIFT_SP_DIR}cluster/json/job.json | \
                ${JQ} ".libs = [\"${JOB_BINARY_ID}\"]" | \
                ${JQ} ".type = \"${JOB_TYPE}\"" | \
                ${JQ} ".name = \"${JOB_NAME}-${RANDOM}-$(date +%Y-%m-%d-%H-%M-%S)\"" \
                > "${OPENSHIFT_SP_DIR}"/tmp/job_resolved.json

            curl -s -X POST "$SAHARA_URL/jobs" \
                         -H "Content-Type: application/json" \
                         -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                         -d @"${OPENSHIFT_SP_DIR}"/tmp/job_resolved.json \
                         > "${OPENSHIFT_SP_DIR}"/tmp/job_response.json

           check_json_errors job_response "creating job"

           JOB_ID=`cat "${OPENSHIFT_SP_DIR}"/tmp/job_response.json | ${JQ} -r '.job.id'`

           client_message "Created job with id: ${JOB_ID}"
}

function runJob() {
    client_message "Runngin job with id: ${JOB_ID} and type ${JOB_TYPE}"
    case ${JOB_TYPE} in
        Java )
            runJavaJob ;;
    esac
}
function runJavaJob() {

            client_message "Running java job..."
            cat ${OPENSHIFT_SP_DIR}cluster/json/job_execution_java.json | \
                ${JQ} ".cluster_id = [\"${SPARK_CLUSTER_ID}\"]" | \
                ${JQ} ".job_configs.configs.\"fs.swift.service.sahara.username\" = \"${fs_swift_service_sahara_username}\"" | \
                ${JQ} ".job_configs.configs.\"fs.swift.service.sahara.password\" = \"${fs_swift_service_sahara_password}\"" | \
                ${JQ} ".job_configs.configs.\"edp.java.main_class\" = \"${edp_java_main_class}\"" \
                > "${OPENSHIFT_SP_DIR}"/tmp/run_job_resolved.json

            for ARG in $JOB_ARGS
            do
                cat ${OPENSHIFT_SP_DIR}tmp/run_job_resolved.json | \
                    ${JQ} ".args += [\"${ARG}\"]" \
                    > "${OPENSHIFT_SP_DIR}"/tmp/run_job_resolved.json
            done

            cat ${OPENSHIFT_SP_DIR}tmp/run_job_resolved.json | ${JQ} -c "."

            curl -s -X POST "$SAHARA_URL/jobs" \
                         -H "Content-Type: application/json" \
                         -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                         -d @"${OPENSHIFT_SP_DIR}"/tmp/run_job_resolved.json \
                         > "${OPENSHIFT_SP_DIR}"/tmp/run_job_response.json

           check_json_errors run_job_response "running job"

           JOB_ID=`cat "${OPENSHIFT_SP_DIR}"/tmp/run_job_response.json | ${JQ} -r '.job.id'`

           client_message "Job started with id: ${JOB_ID}"

}
function createJobInternal() {
   client_message "File $JOB_BINARY exists."
   JOB_INTERNAL_NAME="$(basename $JOB_BINARY)-$(cat $JOB_BINARY | md5sum | /bin/cut -f1 -d" ")"
   client_message "File name of job binary is '${JOB_INTERNAL_NAME}'."

   rawurlencode "$JOB_INTERNAL_NAME"
   client_message "File name will be encoded as '$REPLY'"

   curl -s -X PUT "$SAHARA_URL/job-binary-internals/$REPLY" \
                 -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                 -d @"$JOB_BINARY" \
                 > "${OPENSHIFT_SP_DIR}"/tmp/response_create_job_binary_internals.json


   check_json_errors response_create_job_binary_internals "creating job binary internal"
   JOB_INTERNAL_ID=`cat "${OPENSHIFT_SP_DIR}"/tmp/response_create_job_binary_internals.json | ${JQ} -r '.job_binary_internal.id'`

   client_message "Created job binary internal id: ${JOB_INTERNAL_ID}"


    if [ ${ERROR} == 'DB_DUPLICATE_ENTRY' ]
    then
        curl -s -X GET "$SAHARA_URL/job-binary-internals" \
                    -H "X-Auth-Token: ${OPENSTACK_TOKEN}" \
                    > "${OPENSHIFT_SP_DIR}"/tmp/job_binary_internals_list.json


        JOB_INTERNAL_ID=`cat ${OPENSHIFT_SP_DIR}tmp/job_binary_internals_list.json |
                ${OPENSHIFT_SP_DIR}/bin/jq '.binaries' |
                ${OPENSHIFT_SP_DIR}/bin/jq "map(select(.name==\"${JOB_INTERNAL_NAME}\"))[0].id" |
                cut -d "\"" -f2`

        client_message "Searched JOB_INTERNAL_ID=${JOB_INTERNAL_ID}"s
    fi
}
#!/bin/bash
source $OPENSHIFT_CARTRIDGE_SDK_BASH

created_cluster_template=${OPENSHIFT_DIY_DIR}"created_cluster_template.json"
created_cluster=${OPENSHIFT_DIY_DIR}"created_cluster.json"
runend_job=${OPENSHIFT_DIY_DIR}"runned_job.json"

function run_hook() {
  local path="$OPENSHIFT_REPO_DIR/.openshift/action_hooks/$1"
  if [ -f "$path" -a -x "$path" ]
  then
    "$path"
  else
    return 0
  fi
}

function start() {
    echo "Starting Sahara cartridge"
    if [ -f ${OPENSHIFT_REPO_DIR}/cluster.cfg ]
    then
        source ${OPENSHIFT_REPO_DIR}/cluster.cfg
    fi
}

function deploy(){
    echo "Deploying with Sahara"
    source ${OPENSHIFT_REPO_DIR}/cluster/cluster.properties


    curl -H "Content-Type: application/json" \
            -X POST \
            ${SAHARA_URL}"/v1.0/"${TENANT_ID}"/clusters" \
            -d '{
                "plugin_name": "vanilla",
                "hadoop_version": "2.4.1",
                "cluster_template_id": "'${template_id}'",
                "user_keypair_id": "doc-keypair",
                "name": "doc-cluster",
                "cluster_configs": {}
            }' \
            -o ${created_cluster}

    curl -H "Content-Type: application/json"  \
            -X POST \
            ${SAHARA_URL}'/v1.0/'${TENANT_ID}"/jobs"
            -d @"$OPENSHIFT_REPO_DIR/cluster/job.json" \
            -o ${runend_job}

}
function stop() {
    echo "Stopping Sahara"
}

function restart() {
    stop
    start
}

function status() {
   if output=$(curl http://$OPENSHIFT_DIY_IP:$OPENSHIFT_DIY_PORT 2>&1 )
   then
      client_result "Application is running"
   else
      client_result "Application is either stopped or inaccessible"
   fi
}

function reload() {
    client_result "Reloading Shara cart"
    restart
}

function tidy() {
  client_message "Emptying diy logs in dir: $OPENSHIFT_LOG_DIR"
  shopt -s dotglob
  rm -rf $OPENSHIFT_LOG_DIR/diy.log*
}

case "$1" in
  start)     start ;;
  stop)      stop ;;
  restart)   restart ;;
  status)    status ;;
  reload)    reload ;;
  tidy)      tidy ;;
  *)         exit 0
esac
